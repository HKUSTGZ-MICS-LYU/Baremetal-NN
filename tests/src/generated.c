
#include <stdio.h>
#include <stdlib.h>
#include <math.h>
#include <rv.h>

#include "nn.h"
#include "unittest.h"

int main() {
  enable_accelerator_features();

  size_t cycles = 0;

  
  {
    printf("rms_norm:               ");

    // [-0.0374341  2.682218  -4.115226  -3.6796951 -1.9257718  1.3407868  -0.0990659]
    Tensor *x = NN_tensor(1, (size_t[]){ 7 }, DTYPE_F32, (uint8_t[]){ 0x80,0x54,0x19,0xbd,0x76,0xa9,0x2b,0x40,0xee,0xaf,0x83,0xc0,0x20,0x80,0x6b,0xc0,0xb1,0x7f,0xf6,0xbf,0xe7,0x9e,0xab,0x3f,0x10,0xe3,0xca,0xbd });
    // [ 3.9644475  -0.44372022  1.3230628  -1.5110654  -0.98282695 -4.7767425  -3.3114
    Tensor *w = NN_tensor(1, (size_t[]){ 7 }, DTYPE_F32, (uint8_t[]){ 0x82,0xb9,0x7d,0x40,0x4c,0x2f,0xe3,0xbe,0x1f,0x5a,0xa9,0x3f,0x97,0x6a,0xc1,0xbf,0x8c,0x9a,0x7b,0xbf,0x13,0xdb,0x98,0xc0,0x26,0xee,0x53,0xc0 });


    // [-0.05974785 -0.47915444 -2.192029    2.2385523   0.7619984  -2.5784798   0.1320
    Tensor *golden = NN_tensor(1, (size_t[]){ 7 }, DTYPE_F32, (uint8_t[]){ 0x29,0xba,0x74,0xbd,0xbb,0x53,0xf5,0xbe,0x34,0x4a,0xc,0xc0,0x71,0x44,0xf,0x40,0x54,0x12,0x43,0x3f,0xd0,0x5,0x25,0xc0,0xc6,0x3d,0x7,0x3e });
    Tensor *actual = NN_zeros(1, (size_t[]){ 7 }, DTYPE_F32);

    cycles = read_cycles();
    NN_rms_norm(actual, x, w, 1e-6);                          
    cycles = read_cycles() - cycles;
    printf("%s  (%lu cycles)\n", compare_tensor(golden, actual, 1e-4) ? "PASS" : "FAIL", cycles);

    NN_printf(golden);
    NN_printf(actual);


    NN_delete_tensor(x);
    NN_delete_tensor(w);

    NN_delete_tensor(golden);
    NN_free_tensor_data(actual);
    NN_delete_tensor(actual);
  }

}